import pg from 'pg';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config();

// Database configuration
const pool = new pg.Pool({
  user: 'shovan',
  host: 'localhost',
  database: 'health_data',
  password: '',
  port: 5432,
});

async function fetchHealthData() {
  const client = await pool.connect();
  try {
    console.log('Fetching health data...');
    
    const query = `
      SELECT json_build_object(
        'sleep_analysis', (
          SELECT COALESCE(json_agg(row_to_json(sa)), '[]')
          FROM sleep_analysis sa
          WHERE sa.record_date = CURRENT_DATE
        ),
        'health_aggregated', (
          SELECT COALESCE(json_agg(row_to_json(ha)), '[]')
          FROM health_aggregated ha
          WHERE ha.timestamp >= NOW() - INTERVAL '3 hour'
        ),
        'health_realtime', (
          SELECT COALESCE(json_agg(row_to_json(hr)), '[]')
          FROM health_realtime hr
          WHERE hr.timestamp >= NOW() - INTERVAL '3 hour'
        ),
        'mental_health', (
          SELECT COALESCE(json_agg(row_to_json(mh)), '[]')
          FROM mental_health mh
          WHERE mh.logged_at >= NOW() - INTERVAL '3 hour'
        )
      ) AS all_data`;

    const result = await client.query(query);
    const data = result.rows[0].all_data;

    // Print summary of each category
    console.log('\nData Summary:');
    console.log('=============');
    
    // Sleep Analysis
    console.log('\nSleep Analysis:');
    if (data.sleep_analysis.length > 0) {
      data.sleep_analysis.forEach(record => {
        console.log(`- Date: ${record.record_date}`);
        console.log(`  Sleep Duration: ${record.asleep} hours`);
        console.log(`  Deep Sleep: ${record.deep} hours`);
        console.log(`  REM Sleep: ${record.rem} hours`);
      });
    } else {
      console.log('No sleep records for today');
    }

    // Health Aggregated
    console.log('\nAggregated Health Metrics (last 3 hours):');
    if (data.health_aggregated.length > 0) {
      data.health_aggregated.forEach(record => {
        console.log(`- ${record.metric_name}: ${record.value} ${record.units || ''}`);
        console.log(`  Timestamp: ${new Date(record.timestamp).toLocaleTimeString()}`);
      });
    } else {
      console.log('No aggregated health metrics in the last 3 hours');
    }

    // Health Realtime
    console.log('\nRealtime Health Metrics (last 3 hours):');
    if (data.health_realtime.length > 0) {
      data.health_realtime.forEach(record => {
        console.log(`- ${record.metric_name}: ${record.value}`);
        console.log(`  Timestamp: ${new Date(record.timestamp).toLocaleTimeString()}`);
      });
    } else {
      console.log('No realtime health metrics in the last 3 hours');
    }

    // Mental Health
    console.log('\nMental Health Records (last 3 hours):');
    if (data.mental_health.length > 0) {
      data.mental_health.forEach(record => {
        console.log(`- Mood: ${record.mood}`);
        console.log(`  Heart Rate: ${record.recent_heart_rate}`);
        console.log(`  Energy Burnt: ${record.energy_burnt}`);
        console.log(`  Logged at: ${new Date(record.logged_at).toLocaleTimeString()}`);
      });
    } else {
      console.log('No mental health records in the last 3 hours');
    }

    // Save raw data to file for inspection
    console.log('\nSaving raw data to health_data.json...');
    await fs.writeFile('health_data.json', JSON.stringify(data, null, 2));
    console.log('Data saved successfully!');

  } catch (error) {
    console.error('Error fetching data:', error);
  } finally {
    client.release();
    pool.end();
  }
}

// Run the script
fetchHealthData();
